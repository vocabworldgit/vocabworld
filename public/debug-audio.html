<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umbriel Audio Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .audio-controls {
            margin: 20px 0;
        }
        #log {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üéµ Umbriel Audio Debug Tool</h1>
    
    <div class="test-section">
        <h2>üìã System Status</h2>
        <div id="systemStatus">Checking system status...</div>
    </div>
    
    <div class="test-section">
        <h2>üß™ Audio Tests</h2>
        <button onclick="testManifest()">Test Manifest Loading</button>
        <button onclick="testAudioFiles()">Test Audio File Access</button>
        <button onclick="testDirectPlayback()">Test Direct Playback</button>
        <button onclick="testHybridService()">Test Hybrid Service</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h2>üîä Direct Audio Controls</h2>
        <div class="audio-controls">
            <button onclick="playDirectAudio('2682-hello-en.wav')">Play "Hello" (Direct)</button>
            <button onclick="playDirectAudio('2683-good-morning-en.wav')">Play "Good Morning" (Direct)</button>
            <button onclick="stopAudio()">Stop Audio</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üìù Debug Log</h2>
        <div id="log">Debug log will appear here...\n</div>
    </div>

    <script>
        let currentAudio = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const typeIcon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${typeIcon} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').textContent = 'Debug log cleared...\n';
        }
        
        function updateSystemStatus(message, type) {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        async function checkSystemStatus() {
            log('Checking system status...', 'info');
            
            // Check if we can access the manifest
            try {
                const response = await fetch('/audio/greetings-manifest.json');
                if (response.ok) {
                    updateSystemStatus('‚úÖ Audio manifest accessible', 'success');
                    log('Manifest is accessible', 'success');
                } else {
                    updateSystemStatus('‚ùå Audio manifest not accessible', 'error');
                    log(`Manifest not accessible: ${response.status}`, 'error');
                }
            } catch (error) {
                updateSystemStatus('‚ùå Network error accessing manifest', 'error');
                log(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function testManifest() {
            log('Testing manifest loading...', 'info');
            try {
                const response = await fetch('/audio/greetings-manifest.json');
                if (!response.ok) {
                    log(`Manifest fetch failed: ${response.status} ${response.statusText}`, 'error');
                    return;
                }
                const manifest = await response.json();
                log(`Manifest loaded successfully: ${manifest.topic.title} with ${manifest.statistics.successful} audio files`, 'success');
                log(`Audio format: ${manifest.audio_config.format}, Quality: ${manifest.audio_config.quality}`, 'info');
                return manifest;
            } catch (error) {
                log(`Manifest error: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function testAudioFiles() {
            log('Testing audio file access...', 'info');
            const testFiles = [
                '2682-hello-en.wav',
                '2683-good-morning-en.wav',
                '2684-good-evening-en.wav'
            ];
            
            for (const file of testFiles) {
                try {
                    const audioPath = `/audio/en/${file}`;
                    const audio = new Audio(audioPath);
                    
                    await new Promise((resolve, reject) => {
                        audio.oncanplaythrough = () => {
                            log(`Audio file accessible: ${file}`, 'success');
                            resolve();
                        };
                        audio.onerror = (error) => {
                            log(`Audio file failed: ${file} - ${error.message || 'Unknown error'}`, 'error');
                            reject(error);
                        };
                        setTimeout(() => {
                            log(`Audio file timeout: ${file}`, 'warning');
                            reject(new Error('Timeout'));
                        }, 3000);
                        audio.load();
                    });
                } catch (error) {
                    log(`Audio test error for ${file}: ${error.message}`, 'error');
                }
            }
        }
        
        async function playDirectAudio(filename) {
            log(`Playing direct audio: ${filename}`, 'info');
            try {
                stopAudio(); // Stop any currently playing audio
                
                const audioPath = `/audio/en/${filename}`;
                currentAudio = new Audio(audioPath);
                
                currentAudio.oncanplaythrough = () => {
                    log(`Audio ready to play: ${filename}`, 'info');
                    currentAudio.play().then(() => {
                        log(`Audio started playing: ${filename}`, 'success');
                    }).catch(error => {
                        log(`Play failed: ${error.message}`, 'error');
                    });
                };
                
                currentAudio.onended = () => {
                    log(`Audio finished: ${filename}`, 'success');
                };
                
                currentAudio.onerror = (error) => {
                    log(`Audio error: ${filename} - ${error.message || 'Unknown error'}`, 'error');
                };
                
                currentAudio.load();
            } catch (error) {
                log(`Direct playback error: ${error.message}`, 'error');
            }
        }
        
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
                log('Audio stopped', 'info');
            }
        }
        
        async function testDirectPlayback() {
            log('Testing direct playback...', 'info');
            await playDirectAudio('2682-hello-en.wav');
        }
        
        async function testHybridService() {
            log('Testing if HybridAudioService is available...', 'info');
            
            // Check if the service is available in window
            if (typeof window.HybridAudioService !== 'undefined') {
                log('HybridAudioService found in window', 'success');
            } else {
                log('HybridAudioService not found in window', 'warning');
            }
            
            // Try to access it via dynamic import
            try {
                const module = await import('/lib/hybrid-audio-service.ts');
                log('HybridAudioService module imported successfully', 'success');
            } catch (error) {
                log(`Failed to import HybridAudioService: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            log('Page loaded, starting system check...', 'info');
            checkSystemStatus();
        });
    </script>
</body>
</html>
